<?php
require_once(__DIR__ . '/../config.php');

$conn = get_db_connection();

global $hesk_settings;
$table = $hesk_settings['db_hb_pfix'] . 'hallenbuch';

#$sql = "SELECT * FROM $table ORDER BY id DESC LIMIT 10";
$sql = "SELECT * FROM $table ORDER BY datum DESC, von DESC LIMIT 10";

$result = mysqli_query($conn, $sql);

if ($result && mysqli_num_rows($result) > 0) {
    echo "<h3>Letzte Eintr채ge:</h3>";

    // Manuell definierte Spalten체berschriften (ohne ID)
    $columnConfig = [
        'datum'     => ['label' => 'Datum',     'width' => '100px'],
        'von'       => ['label' => 'Von',       'width' => '60px'],
        'bis'       => ['label' => 'Bis',       'width' => '60px'],
        'gruppe'    => ['label' => 'Gruppe',    'width' => '120px'],
        'leiter'    => ['label' => 'Leiter',    'width' => '120px'],
        'bemerkung' => ['label' => 'Bemerkung', 'width' => '300px']
    ];
//    $columnLabels = [
//        'datum'     => 'Datum',
//        'von'       => 'Von',
//        'bis'       => 'Bis',
//        'gruppe'    => 'Gruppe',
//        'leiter'    => 'Leiter',
//        'vermerk'   => 'Vermerk',
//        'bemerkung' => 'Bemerkung'
//    ];

    echo "<table border='1' cellpadding='5' cellspacing='0'>";
    echo "<tr>";
    foreach ($columnConfig as $key => $config) {
        echo "<th style='width:{$config['width']};'>{$config['label']}</th>";
    }
//    foreach ($columnLabels as $label) {
//        echo "<th>$label</th>";
//    }
    echo "</tr>";

    while ($row = mysqli_fetch_assoc($result)) {
        echo "<tr>";
        foreach ($columnLabels as $key => $label) {
            $value = $row[$key];

            // Zeitfelder k체rzen auf HH:MM
            if (in_array($key, ['von', 'bis']) && strlen($value) >= 5) {
                $value = substr($value, 0, 5);
            }

    	    // Datum umwandeln in TT.MM.JJJJ
	        if ($key === 'datum' && !empty($value)) {
	            $dateObj = DateTime::createFromFormat('Y-m-d', $value);
	            if ($dateObj) {
	                $value = $dateObj->format('d.m.Y');
	            }
	        }

            echo "<td style='width:{$config['width']};'>$value</td>";
//            echo "<td>$value</td>";
        }
        echo "</tr>";
    }

    echo "</table>";
} else {
    echo "<p>Keine Eintr채ge gefunden.</p>";
}

mysqli_close($conn);

