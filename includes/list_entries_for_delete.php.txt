<?php
require_once(__DIR__ . '/../config.php');
$conn = get_db_connection();
global $hesk_settings;
$table = $hesk_settings['db_hb_pfix'] . 'hallenbuch';

// Auswahl f√ºr Anzahl der Eintr√§ge
$limitOptions = [10, 25, 50, 100, 'ALLE'];
$selectedLimit = $_GET['limit'] ?? 10;
$selectedLimit = in_array($selectedLimit, $limitOptions) ? $selectedLimit : 10;

// Datumsfilter
$selectedDate = $_GET['filter_date'] ?? '';
$dateCondition = '';
if (!empty($selectedDate)) {
    $dateObj = DateTime::createFromFormat('Y-m-d', $selectedDate);
    if ($dateObj) {
        $formattedDate = $dateObj->format('Y-m-d');
        $dateCondition = "WHERE datum = '$formattedDate'";
    }
}

// L√∂schvorgang
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['delete_ids'])) {
    $idsToDelete = array_map('intval', $_POST['delete_ids']);
    if (!empty($idsToDelete)) {
        $idList = implode(',', $idsToDelete);
        $deleteSql = "DELETE FROM $table WHERE id IN ($idList)";
        mysqli_query($conn, $deleteSql);
    }
}

// Eintr√§ge abrufen
$limitClause = ($selectedLimit === 'ALLE') ? '' : "LIMIT " . intval($selectedLimit);
$sql = "SELECT * FROM $table $dateCondition ORDER BY datum DESC, von DESC $limitClause";
$result = mysqli_query($conn, $sql);

// Auswahlformular
echo "<form method='GET' style='margin-bottom: 10px; display: flex; gap: 20px; align-items: center;'>";

// Limit-Auswahl
echo "<label for='limit'>Anzahl Eintr√§ge:</label> ";
echo "<select name='limit' id='limit'>";
foreach ($limitOptions as $option) {
    $selected = ($selectedLimit == $option) ? "selected" : "";
    echo "<option value='$option' $selected>$option</option>";
}
echo "</select>";

// Datumsfilter
echo "<label for='filter_date'>Datum filtern:</label> ";
echo "<input type='date' name='filter_date' id='filter_date' value='" . htmlspecialchars($selectedDate) . "'>";

echo "<button type='submit'>Filtern</button>";
echo "</form>";

echo "<h3>Letzte Eintr√§ge:</h3>";

if ($result && mysqli_num_rows($result) > 0) {
    $columnConfig = [
        'datum'     => ['label' => 'Datum',     'width' => '80px'],
        'von'       => ['label' => 'Von',       'width' => '50px'],
        'bis'       => ['label' => 'Bis',       'width' => '50px'],
        'gruppe'    => ['label' => 'Gruppe',    'width' => '100px'],
        'leiter'    => ['label' => 'Leiter',    'width' => '100px'],
        'bemerkung' => ['label' => 'Bemerkung', 'width' => '200px']
    ];

    echo "<form method='POST'>";
    echo "<table class='last-entries' style='table-layout: fixed; width: 100%; border-collapse: collapse;'>";

    // Tabellenkopf
    echo "<tr>";
    echo "<th style='width:30px; border: 1px solid #ccc; padding: 4px;'>üóëÔ∏è</th>";
    foreach ($columnConfig as $key => $config) {
        echo
